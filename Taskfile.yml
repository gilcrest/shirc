version: '3'

includes:
  validate-prerequisites: ./tasks/validate-prerequisites/validate-prerequisite-tasks.yml
  aws-cli: ./tasks/aws-cli/awscli-tasks.yml

env:
  ENV_DIR: .env
  TEMP_DIR: tmp

dotenv: ['{{ .ENV_DIR }}/{{ .DOTENV_FILENAME | default "iceberg.env" }}']

tasks:

  aws-resources-up:
    desc: Validates AWS CLI, creates S3 bucket, generates and creates IAM policy.
    cmds:
      - task: validate-prerequisites:awscli
      - task: aws-cli:make-s3-bucket
        vars:
          S3_BUCKET_NAME: $S3_BUCKET_NAME
          AWS_REGION: $AWS_REGION
      - task: aws-cli:generate-iam-policy-for-s3-bucket-access
        vars:
          S3_BUCKET_NAME: $S3_BUCKET_NAME
          S3_PREFIX: $S3_PREFIX
      - task: aws-cli:create-iam-policy
        vars:
          IAM_POLICY_NAME: $IAM_POLICY_NAME
      - task: aws-cli:generate-trust-policy
      - task: aws-cli:create-iam-role
        vars:
          IAM_ROLE_NAME: $IAM_ROLE_NAME
      - task: aws-cli:attach-policy-to-role

  aws-resources-teardown:
    desc: Deletes the IAM role, IAM policy, and S3 bucket.
    cmds:
      - task: validate-prerequisites:awscli
      - task: aws-cli:detach-policy-from-role
      - task: aws-cli:delete-iam-role
      - task: aws-cli:delete-iam-policy
      - task: aws-cli:delete-s3-bucket
        vars:
          S3_BUCKET_NAME: $S3_BUCKET_NAME
          FORCE: $FORCE